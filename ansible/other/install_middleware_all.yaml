# eureka.yml

- name: scp package
  remote_user: swift
  hosts: eureka_host
  gather_facts: False
  tasks:
  - name: start eureka server
    raw: docker run -itd --name eureka --pid="host" --net="host"  --cpus 2 -m 2G -h localhost -l basic.hostname=$(hostname) -l basic.ip=${localip} -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 swr.cn-east-2.myhuaweicloud.com/common-server/eureka:1


# nacos.yml

- name: scp package
  remote_user: swift
  hosts: nacos_host
  gather_facts: False
  tasks:
    - name: scp config file
      copy:
        src: /home/swift/devops/Autoinstall/nacos_conf/
        dest: /tmp/nacos_conf/
    - name: create nacos dir
      raw: mkdir /opt/nacos-mysql/data/ -p  && chmod 777 /opt/nacos-mysql/data/ && cp -pr /tmp/nacos_conf/* /opt/nacos-mysql/ && mkdir /opt/nacos/ -p && echo 'management.endpoints.web.exposure.include=*' > /opt/nacos/custom.properties && chmod 777 /opt/nacos/custom.properties
    - name: get hosts ip
      setup:
        gather_subset:
          - "network"
      register: result
    - name: start nacos mysql
      raw: docker run -itd --name nacos-mysql -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -v /opt/nacos-mysql/data:/var/lib/mysql --env-file /opt/nacos-mysql/mysql.env swr.cn-east-2.myhuaweicloud.com/common-server/nacos-mysql:1
    - name: start nacos server
      raw: docker run -itd --name nacos-server -h localhost --link nacos-mysql -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PREFER_HOST_MODE=hostname -e MODE=standalone -e SPRING_DATASOURCE_PLATFORM=mysql -e MYSQL_MASTER_SERVICE_HOST=nacos-mysql -e MYSQL_MASTER_SERVICE_DB_NAME=nacos_devtest -e MYSQL_MASTER_SERVICE_PORT=3306 -e MYSQL_MASTER_SERVICE_USER=nacos -e MYSQL_MASTER_SERVICE_PASSWORD=nacos -p 8848:8848 -p 9555:9555 -v /opt/nacos/standalone-logs/:/home/nacos/logs -v /opt/nacos/custom.properties:/home/nacos/init.d/custom.properties swr.cn-east-2.myhuaweicloud.com/common-server/nacos-server:1
      # raw: docker run -itd --name nacos-server -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PREFER_HOST_MODE=hostname -e MODE=standalone -e SPRING_DATASOURCE_PLATFORM=mysql -e MYSQL_MASTER_SERVICE_HOST=local-nacos-mysql -e MYSQL_MASTER_SERVICE_DB_NAME=nacos_devtest -e MYSQL_MASTER_SERVICE_PORT=3307 -e MYSQL_MASTER_SERVICE_USER=nacos -e MYSQL_MASTER_SERVICE_PASSWORD='nacospassword' -p 8848:8848 -p 9555:9555 -v /opt/nacos/standalone-logs/:/home/nacos/logs -v /opt/nacos/custom.properties:/home/nacos/init.d/custom.properties swr.cn-east-2.myhuaweicloud.com/common-server/nacos-server:1


# xxljob.yml

- name: scp package
  remote_user: swift
  hosts: xxljob_host
  gather_facts: False
  tasks:
  - name: create xxljob dir
    raw: mkdir /opt/xxljob/log -p && chmod 777 /opt/xxljob/log && mkdir /opt/xxljob-mysql/data -p && chmod 777 /opt/xxljob-mysql/data
  - name: get hosts ip
    setup:
      gather_subset:
        - 'network'
    register: result
  - name: start xxljob mysql 
    raw: docker run -itd --name xxljob-mysql -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -v /opt/xxljob-mysql/data:/var/lib/mysql --memory-swappiness=0 swr.cn-east-2.myhuaweicloud.com/common-server/xxljob-mysql:2
  - name: start xxljob server
    raw: docker run -d --cap-add=SYS_PTRACE --name xxl-job --link xxljob-mysql -p 10116:10116 -h localhost -v /opt/xxljob/logs:/data/applogs -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PARAMS="--spring.datasource.url=jdbc:mysql://xxljob-mysql:3306/xxl_job?Unicode=true&useSSL=false&characterEncoding=UTF-8 --spring.datasource.username=root --spring.datasource.password=q1w2e3r4 --xxl.job.accessToken=8b5c687b81852fcc63a795060ee79d15d66467e0 --server.port=10116" swr.cn-east-2.myhuaweicloud.com/common-server/xxljob:1

# docker run -itd --name xxljob-mysql2 -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -v /opt/xxljob-mysql/data:/var/lib/mysql --memory-swappiness=0 swr.cn-east-2.myhuaweicloud.com/common-server/xxljob-mysql:2
# docker run -d --cap-add=SYS_PTRACE --name xxl-job2 --link xxljob-mysql2 -p 10116:10116 -h localhost -v /opt/xxljob/logs:/data/applogs -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PARAMS="--spring.datasource.url=jdbc:mysql://xxljob-mysql:3306/xxl_job?Unicode=true&useSSL=false&characterEncoding=UTF-8 --spring.datasource.username=root --spring.datasource.password=q1w2e3r4 --xxl.job.accessToken=8b5c687b81852fcc63a795060ee79d15d66467e0 --server.port=10116" swr.cn-east-2.myhuaweicloud.com/common-server/xxljob:1
# docker run -d --cap-add=SYS_PTRACE --name xxl-job2 -p 10117:10116 -h localhost -v /etc/hosts:/etc/hosts -v /opt/xxljob/logs:/data/applogs -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PARAMS="--spring.datasource.url=jdbc:mysql://xxljob-mysql:3306/xxl_job?Unicode=true&useSSL=false&characterEncoding=UTF-8 --spring.datasource.username=root --spring.datasource.password=q1w2e3r4 --xxl.job.accessToken=8b5c687b81852fcc63a795060ee79d15d66467e0 --server.port=10116" swr.cn-east-2.myhuaweicloud.com/common-server/xxljob:1
# docker run -d --cap-add=SYS_PTRACE --name xxl-job2 -p 9380:10116 -h localhost -v /etc/hosts:/etc/hosts -v /opt/xxljob/logs:/data/applogs -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PARAMS="--spring.datasource.url=jdbc:mysql://xxljob-mysql:3306/xxl_job?Unicode=true&useSSL=false&characterEncoding=UTF-8 --spring.datasource.username=root --spring.datasource.password=xxljobpassword --xxl.job.accessToken=8b5c687b81852fcc63a795060ee79d15d66467e0 --server.port=10116" swr.cn-east-2.myhuaweicloud.com/common-server/xxljob:1


# docker run -itd --name nacos-server2 -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e PREFER_HOST_MODE=hostname -e MODE=standalone -e SPRING_DATASOURCE_PLATFORM=mysql -e MYSQL_MASTER_SERVICE_HOST=local-nacos-mysql -e MYSQL_MASTER_SERVICE_DB_NAME=nacos_devtest -e MYSQL_MASTER_SERVICE_PORT=3307 -e MYSQL_MASTER_SERVICE_USER=nacos -e MYSQL_MASTER_SERVICE_PASSWORD='nacospassword' -p 8848:8848 -p 9555:9555 -v /opt/nacos/standalone-logs/:/home/nacos/logs -v /opt/nacos/custom.properties:/home/nacos/init.d/custom.properties swr.cn-east-2.myhuaweicloud.com/common-server/nacos-server:1

# GRANT ALL PRIVILEGES ON *.* TO root@'%' IDENTIFIED BY 'xxljobpassword' WITH GRANT OPTION;
# GRANT ALL PRIVILEGES ON *.* TO root@'localhost' IDENTIFIED BY 'xxljobpassword' WITH GRANT OPTION;
# FLUSH PRIVILEGES;

# GRANT ALL PRIVILEGES ON *.* TO root@'%' IDENTIFIED BY 'q1w2e3r4' WITH GRANT OPTION;
# GRANT ALL PRIVILEGES ON *.* TO root@'localhost' IDENTIFIED BY 'q1w2e3r4' WITH GRANT OPTION;
# FLUSH PRIVILEGES;


# redis6.0.yml

- name: install redis-6.0
  remote_user: swift
  hosts: redis_host
  gather_facts: False
  tasks:
  - name: start redis-6.0
    raw: mkdir /opt/redis-6.0/data/ -p  && mkdir /opt/redis-6.0/logs -p && sudo chmod 777 /opt/redis-6.0/data/ && chmod 777 /opt/redis-6.0/logs
  - name: scp config file
    copy:
      src: /home/swift/devops/Autoinstall/redis-6.0_conf/
      dest: /opt/redis-6.0/
  - name: start redis
    raw: docker run -itd --name redis-6.0 -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -v /opt/redis-6.0/redis.conf:/etc/redis-6.0/redis.conf -v /opt/redis-6.0/data:/opt/redis-6.0/data -v /opt/redis-6.0/logs:/opt/redis-6.0/logs --net="host"  --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --memory-swappiness=0 swr.cn-east-2.myhuaweicloud.com/common-server/redis:6.0.14 /etc/redis-6.0/redis.conf


# rocketmq.yml

- name: install rocketmq
  remote_user: swift
  hosts: rocketmq_host
  gather_facts: False
  tasks:
  - name: mkdir
    raw: mkdir /opt/rocketmq/conf/2m-noslave/ -p && mkdir /opt/rocketmq/store && mkdir /opt/rocketmq/logs && chmod 777 /opt/rocketmq/store && chmod 777 /opt/rocketmq/logs
    ignore_errors: True
  - name: install packages
    raw: cd /tmp/ && rm -rf archives
  - name: get hosts ip
    setup:
       gather_subset:
         - "network"
    register: result
  - name: Show debug info 
    debug: var=result['ansible_facts']['ansible_default_ipv4']['address']
  - name: rm rocketmq_hosts
    local_action:  command sudo rm -rf /tmp/remote_rocketmq_host
  - name: echo address to local
    local_action: shell cd /tmp/ && echo {{ result['ansible_facts']['ansible_default_ipv4']['address'] }} >> remote_rocketmq_host
  - name: scp config to remote
    local_action:  command scp /tmp/remote_rocketmq_host {{ inventory_hostname }}:/tmp/
  - name: scp config file
    copy:
      src: /home/swift/devops/Autoinstall/rocketmq_conf/
      dest: /tmp/rocketmq_conf/
  - name: get Cluster ip
    raw: cat /tmp/remote_rocketmq_host
    register: client_ip
  - name: change Config 
    raw:  sed -i "s|##HOST_NUM##|001|g" /tmp/rocketmq_conf/broker.properties
    when: ( result['ansible_facts']['ansible_default_ipv4']['address'] == client_ip.stdout_lines[0] )
  - name: Check ip 
    raw:  sed -i "s|##HOST_NUM##|002|g" /tmp/rocketmq_conf/broker.properties
    when: ( result['ansible_facts']['ansible_default_ipv4']['address'] == client_ip.stdout_lines[1] )
  - name: cp config file
    raw: sudo cp /tmp/rocketmq_conf/broker.properties /opt/rocketmq/conf/2m-noslave/
  - name: echo hosts
    raw: echo '{{ client_ip.stdout_lines[0] }}  local-rocketmq-001' |sudo tee -a /etc/hosts
  - name: echo hosts-002
    raw: echo '{{ client_ip.stdout_lines[1] }}  local-rocketmq-002' |sudo tee -a /etc/hosts
  - name: start name-server
    raw: docker run -itd --name rocketmq-namesrv -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -m 4G --net="host"  --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --memory-swappiness=0 swr.cn-east-2.myhuaweicloud.com/common-server/rocketmq:4.3.0 ./mqnamesrv
  - name: start broken
    raw: docker run -itd --name rocketmq-broker -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --net="host"  -m 4G  --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --memory-swappiness=0 -v /opt/rocketmq/store:/home/rocketmq/store -v /opt/rocketmq/conf/2m-noslave:/opt/rocketmq-4.3.0/conf/2m-noslave/ -v /opt/rocketmq/logs:/home/rocketmq/logs swr.cn-east-2.myhuaweicloud.com/common-server/rocketmq:4.3.0 ./mqbroker -c /opt/rocketmq-4.3.0/conf/2m-noslave/broker.properties autoCreateTopicEnable=true

# rocketmq-console.yml

- name: scp package
  remote_user: swift
  hosts: rocketmq-console_host
  gather_facts: False
  vars:
    rocketmq_nameserver: local-rocketmq-001
  tasks:
  - name: start rocketmq-console
    raw: docker run -itd --name rocketmq-console --net="host"  -m 1G --cpus 1 -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=unless-stopped -e  "JAVA_OPTS=-Drocketmq.namesrv.addr={{ rocketmq_nameserver }}:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false" swr.cn-east-2.myhuaweicloud.com/common-server/rocketmq-console:1 --rocketmq.client.logUseSlf4j=true --rocketmq.client.log.loadconfig=false

# rocketmq-exporter.yml

- name: install rocketmq-exporter
  remote_user: swift
  hosts: rocketmq-exporter_host
  gather_facts: False

  tasks:
    - name: start rocketmq-exporter
      raw: docker run -itd --cap-add=SYS_PTRACE --name rocketmq-exporter -h $(hostname) -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -v /:/host:ro --cpus 1 -m 1G --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --net="host"  --pid="host" swr.cn-east-2.myhuaweicloud.com/common-server/rocketmq-exporter:1


# mongo.yml

- name: install mongo
  remote_user: swift
  hosts: mongo_host
  gather_facts: False
  tasks:
  - name: mkdir
    raw: mkdir /opt/mongo/{data,logs} -p && chmod 777 /opt/mongo/{data,logs}
    ignore_errors: True
  - name: get_hosts_ip
    setup:
        gather_subset:
            - 'network'
    register: result
  - name: scp config file
    copy:
      src: /home/swift/devops/Autoinstall/mongo_conf/mongod.conf
      dest: /opt/mongo/
  - name: echo hosts
    raw: echo '{{ result['ansible_facts']['ansible_default_ipv4']['address'] }}  local-mongo' |sudo tee -a /etc/hosts
  - name: start mongo
    raw: docker run -itd --name mongo -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -v /opt/mongo/mongod.conf:/etc/mongod.conf -v /opt/mongo/data:/var/lib/mongodb -v /opt/mongo/logs:/var/log/mongodb/ --net="host"  --cap-add=SYS_PTRACE --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --memory-swappiness=0 swr.cn-east-2.myhuaweicloud.com/common-server/mongo:4.0.17 -f /etc/mongod.conf
  ### 
  - name: set passwd
    raw: sleep 10 && docker exec -it mongo mongo admin --eval "db.createUser({user:'root', pwd:'mongopassword', roles:['root']})"


# elasticsearch.yml

- name: install elasticsearch
  remote_user: swift
  hosts: elasticsearch_host
  gather_facts: False
  tasks:
  - name: mkdir
    raw: mkdir -p /opt/elasticsearch/data && chmod 777 /opt/elasticsearch/data
  - name: start elasticsearch server
    raw: docker run --cap-add=SYS_PTRACE -itd --name es -h localhost -p 9200:9200  -p 9300:9300  --cpus 2 -m 4G --ulimit memlock=-1:-1 -e "ES_JAVA_OPTS=-Xms3g -Xmx3g" -e "bootstrap.memory_lock=true" -v /opt/elasticsearch/data:/usr/share/elasticsearch/data --memory-swappiness=0 --restart=on-failure:3 -v /etc/localtime:/etc/localtime -v /etc/hosts:/etc/hosts swr.cn-east-2.myhuaweicloud.com/common-server/elasticsearch-base:5.6.16

# htpdate-master.yml

- name: install htpdate
  remote_user: swift
  hosts: htpdate-master_host
  gather_facts: False
  tasks:
  - name: scp source file
    local_action:  command scp /home/swift/packages/htpdate.tar {{ inventory_hostname }}:/tmp
  - name: install packages
    raw: cd /tmp/ && sudo rm -rf archives && tar -xvf htpdate.tar && cd archives && sudo dpkg -i *.deb
    ignore_errors: True
  - name: sync date
    raw: sudo htpdate -s -t gateway.xxxxxxxxxxx.com
  - name: echo crontab
    raw: (crontab -l;echo '01 * * * * sudo htpdate -s -t gateway.xxxxxxxxxxx.com') |crontab

# htpdate-slave.yml

- name: install htpdate
  remote_user: swift
  hosts: htpdate-slave_host
  gather_facts: False
  vars:
    gateway_url: local-gateway:8080
  tasks:
  - name: scp source file
    local_action:  command scp /home/swift/packages/htpdate.tar {{ inventory_hostname }}:/tmp
  - name: install packages
    raw: cd /tmp/ && sudo rm -rf archives && tar -xvf htpdate.tar && cd archives && sudo dpkg -i *.deb
    ignore_errors: True
  - name: sync date
    raw: sudo htpdate -s -t {{ gateway_url }}
  - name: echo crontab                                            
    raw: (crontab -l;echo '01 * * * * sudo htpdate -s -t {{ gateway_url }}') |crontab


# prometheus.yml

- name: install prometheus
  remote_user: swift
  hosts: prometheus_host
# 在hosts文件中添加主机的时候，记得添加[prometheus_host:vars]，在里面添加全局变量env_name=xxxxx-prod
  gather_facts: False

  tasks:
    - name: remove prometheus_conf
      raw: cd /tmp/ && rm -rf /tmp/prometheus_conf/
      connection: local

    - name: cp config file to tmp
      raw: cp -rp /home/swift/devops/Autoinstall/prometheus_conf/ /tmp/prometheus_conf/
      connection: local
    
       # envname=`echo "{{ inventory_hostname.split('-')[0].lower() }}-prod" | awk -F '-' '{print $1}'`
    - name: edit prometheus_conf
      shell: |
        #! /bin/bash
        echo 
        envname="{{ inventory_hostname.split('-')[0].lower() }}"
        name=`cat /etc/ssh/ssh_config | grep -i "${envname}" | grep -i "host" | grep -vi "test" | awk '{print $2}'`
        for i in $name;do
            if ! grep $i /tmp/prometheus_conf/env_name-docker.yml
            then
              echo "   - "$i":12581" >> /tmp/prometheus_conf/env_name-docker.yml
              echo "   - \"$i:12580\"" >> /tmp/prometheus_conf/env_name.yml
              if [[ $i =~ 'MQ-001' ]]
              then
                sed -i '/##MQ-001##/$i/' >> /tmp/prometheus.yml
              fi
            else
              echo $i "已存在"
            fi
        done
      connection: local
    - name: scp config file
      copy:
#        src: /var/lib/jenkins/devops/Autoinstall/prometheus_conf/
        # src: /home/swift/devops/Autoinstall/prometheus_conf/
        src: /tmp/prometheus_conf/
        dest: /tmp/prometheus/prometheus_conf/

    - name: get_remote_host_ip
      setup:
        gather_subset:
          - "network"
      register: result

    - name: collocate config file
      raw: cd /tmp/prometheus/prometheus_conf && rename 's/env_name/{{ inventory_hostname.split('-')[0].lower() }}-prod/' *.yml

    - name: config file
      raw: sed -i 's|##env_name##|{{ inventory_hostname.split('-')[0].lower() }}-prod|g' /tmp/prometheus/prometheus_conf/prometheus.yml && sed -i 's|##env_name##|{{ inventory_hostname.split('-')[0].lower() }}-prod|g' /tmp/prometheus/prometheus_conf/{{ inventory_hostname.split('-')[0].lower() }}-prod-http.yml && sed -i "s|##local_ip##|{{ result['ansible_facts']['ansible_default_ipv4']['address'] }}|g" /tmp/prometheus/prometheus_conf/prometheus.yml

    - name: create prometheus
      raw: mkdir /opt/prometheus/data -p && chmod 777 /opt/prometheus/data &&mkdir /opt/prometheus/conf && cp -pr /tmp/prometheus/prometheus_conf/* /opt/prometheus/conf/ && mv /opt/prometheus/conf/prometheus.yml /opt/prometheus/
      ignore_errors: True

    - name: start prometheus
      raw: docker run -itd --name prometheus --cap-add=SYS_PTRACE -h localhost -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -p 9090:9090 -v /opt/prometheus/data/:/prometheus  -v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml -v /opt/prometheus/conf/:/etc/prometheus/conf/ swr.cn-east-2.myhuaweicloud.com/common-server/prometheus

    - name: create blackbox-expoter
      raw: mkdir /opt/blackbox && cp -pr /tmp/prometheus/prometheus_conf/blackbox.yml /opt/blackbox/
      ignore_errors: True

    - name: start blackbox-expoter
      raw: docker run -itd --name blackbox_exporter -p 12582:9115 --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -v /opt/blackbox/:/config swr.cn-east-2.myhuaweicloud.com/common-server/blackbox-exporter --config.file=/config/blackbox.yml
      ignore_errors: True

    - name: start redis-expoter
      raw: docker run -itd --cap-add=SYS_PTRACE --name redis_exporter -p 12586:9121 -h $(hostname) -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cpus 1 -m 1G --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 swr.cn-east-2.myhuaweicloud.com/common-server/redis_exporter:1  --redis.addr redis://local-redis:6379 --redis.password '123456'
      ignore_errors: True

    - name: start cadvisor
      raw: docker run -itd --name cadvisor --privileged=true --name=cadvisor -p 12581:8080 --cpus 1 -m 1G --log-opt max-size=512m --log-opt max-file=3 --restart=on-failure:3 -v /:/rootfs:ro -v /var/run:/var/run:rw -v /sys:/sys:ro -v /var/lib/docker/:/var/lib/docker:ro -v /dev/disk/:/dev/disk:ro swr.cn-east-2.myhuaweicloud.com/common-server/cadvisor
      ignore_errors: True

    - name: start node-exporter
      raw: docker run -itd --cap-add=SYS_PTRACE --name node-exporter -h $(hostname) -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime -v /:/host:ro --cpus 1 -m 1G --cap-add=SYS_PTRACE --restart=on-failure:3 --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 --net="host"  --pid="host" swr.cn-east-2.myhuaweicloud.com/common-server/node-exporter --path.rootfs=/host --web.listen-address=":12580"
      ignore_errors: True
