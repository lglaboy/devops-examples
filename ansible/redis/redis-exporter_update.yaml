# Date: 2023-08-09 14:47
# Author: lglaboy
# GitHub: https://github.com/lglaboy
# Description: 获取redis密码，更新redis-exporter
# Version: v1.0

# 多线程批量运行 -f 100
- name: init env
  hosts: localhost
  connection: local
  gather_facts: False
  vars:
    log_file: /tmp/redis_and_redis_exporter_password
    log_file_suffix: .csv
    log_file_path: "{{log_file}}{{log_file_suffix}}"
  tasks:
    # 初始化日志文件
    - name: 初始化日志文件
      shell: if [ -f {{log_file_path}} ];then mv {{log_file_path}} {{log_file_path}}_$(date +"%Y_%m_%d_%H_%M_%S");fi
    # 获取主机
    - name: get hosts
      shell: grep -E "Host\s+" /etc/ssh/ssh_config | grep -E -v -i "^#|\*|JENKINS|gitlab|kubevirt|LOCALTEST|LOCAL-DEMO|LOCALDEMO|KR|K3S|K8S|ALIYUN|-DEV-|-TEST|sw|sky|CLOUD|SENTRY" | awk '{print $NF}' | sort
      register: grep_hosts
    # 添加主机到临时主机组
    - add_host:
        name: "{{ item }}"
        group: get_hosts
      with_items: "{{grep_hosts.stdout_lines}}"

- name: get info
  hosts: get_hosts
  remote_user: swift
  gather_facts: False
  vars:
    log_file: /tmp/redis_and_redis_exporter_password
    log_file_suffix: .csv
    log_file_path: "{{log_file}}{{log_file_suffix}}"
  tasks:
    - name: 判断是否存在redis容器
      shell: docker ps | grep redis | grep -v -E "test|exporter|k8s|sentry" | wc -l
      register: redis_status
    - name: 判断是否存在redis-exporter容器
      shell: docker ps | grep redis_exporter | wc -l
      register: redis_exporter_status
    # 获取redis信息
    - block:
      - name: 获取redis name
        shell: docker ps -a |grep redis| grep -v -E "test|exporter|k8s|sentry" |awk '{print $NF}'
        # ignore_errors: true
        register: redis_name
      - name: 获取redis配置文件中的密码
        shell: grep ^requirepass /opt/{{ redis_name.stdout }}/redis.conf |awk '{print $NF}'
        # ignore_errors: true
        register: redis_requirepass
      - name: 检查配置文件中是否修改了 config 命令
        shell: grep "^rename-command" /opt/{{ redis_name.stdout }}/redis.conf | grep -i "config" | awk '{print $NF}'
        register: redis_command_config
      - name: 输出redis信息
        local_action: shell echo "{{ inventory_hostname }},{{ redis_name.stdout }},{{redis_command_config.stdout}},{{ redis_requirepass.stdout }}" >> "{{ log_file_path }}"
      when:
        - redis_status['stdout']|int > 0
    # 获取redis-exporter信息
    - block:
      - name: 从日志输入文件中获取redis记录,仅获取密码是XXXX的
        connection: local
        shell: grep -i "{{ inventory_hostname.split('-')[0].upper() }}-" {{ log_file_path }} | grep XXXX -c | cat
        register: local_redis_count
      - name: 从日志输入文件中获取redis 相关信息 
        connection: local
        shell: grep -i "{{ inventory_hostname.split('-')[0].upper() }}-" {{ log_file_path }} | grep XXXX
        register: local_redis_info
        when: local_redis_count.stdout|int == 1
        # local_redis_info.stdout

      - name: get redis_exporter connection redis pg_password
        shell: docker inspect --format='{{ '{{'  }}.Args{{ '}}' }}' redis_exporter | sed 's/]//g' | awk '{print $NF}'
        register: redis_exporter_password

      # 对比密码
      - block:
        - name: 删除旧的redis_exporter
          shell: docker rm -f redis_exporter
        - name: 使用自定义config命令 启动redis_exporter
          shell: docker run -itd --cap-add=SYS_PTRACE --name redis_exporter -p 12586:9121 -h $(hostname) -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cpus 1 -m 1G --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 -e REDIS_EXPORTER_CONFIG_COMMAND={{local_redis_info.stdout.split(',')[2]}} swr.cn-east-2.myhuaweicloud.com/common-server/redis_exporter:1  --redis.addr redis://local-redis:6379 --redis.password {{local_redis_info.stdout.split(',')[3]}}
          when: 
            - local_redis_info.stdout.split(',')[2] != ""
        - name: 使用默认config命令 启动redis_exporter
          shell: docker run -itd --cap-add=SYS_PTRACE --name redis_exporter -p 12586:9121 -h $(hostname) -v /etc/hosts:/etc/hosts -v /etc/localtime:/etc/localtime --cpus 1 -m 1G --restart=unless-stopped --memory-swappiness=0 --log-opt max-size=512m --log-opt max-file=3 swr.cn-east-2.myhuaweicloud.com/common-server/redis_exporter:1  --redis.addr redis://local-redis:6379 --redis.password {{local_redis_info.stdout.split(',')[3]}}
          when: 
            - local_redis_info.stdout.split(',')[2] == ""
        - name: 输出redis_exporter信息
          connection: local
          shell: echo "{{ inventory_hostname }},redis_exporter,{{ redis_exporter_password.stdout }},{{ local_redis_info.stdout.split(',')[3] }}" >> "{{ log_file_path }}"
        when: 
          - local_redis_info is defined
          - local_redis_info.stdout is defined
          - redis_exporter_password.stdout != local_redis_info.stdout.split(',')[3]
      when:
        - redis_exporter_status['stdout']|int > 0