# Date: 2022-11-17 14:53
# Author: lglaboy
# GitHub: https://github.com/lglaboy
# Description: 安装loki,分为read,write,gateway,采用本地存储，1d
# Version: v1.0
- name: install loki
  hosts: loki_docker_hosts
  remote_user: swift
  gather_facts: False
  tasks:
    - name: get_hosts_ip
      setup:
        gather_subset:
          - 'network'
      register: result
    - name: echo address to local
      local_action: shell printf "{{ result['ansible_facts']['ansible_default_ipv4']['address'] }}" > "/tmp/{{ inventory_hostname|lower|regex_replace('-(.*)') }}_loki_host"
    - name: Check to see if loki is installed
      shell: docker ps |grep -E "logging-loki-(read|write|gateway)" -c|cat
      register: loki_docker_register
    - name: 检查3100端口是否使用
      shell: nc -z 0.0.0.0 3100;echo $?
      register: loki_port_register
      ignore_errors: True
    - name: 检查network是否存在
      shell: docker network ls|grep logging -c|cat
      register: loki_network_register
      ignore_errors: True
    - name: 检查subnet是否冲突
      shell: route -n |grep 172.30.30.0 -c|cat
      register: loki_network_subnet_register
    - name: 检查目录是否存在
      stat:
        path: /opt/loki
      register: loki_path
    # - debug:
    #     msg: "Path exists and is a directory"
    #   when: loki_path.stat.isdir is defined and loki_path.stat.isdir
    - block:
      - name: 检查loki all image是否存在
        shell: docker images |awk '{print $1":"$2}'|grep -c -E swr.cn-east-2.myhuaweicloud.com/common-server/"(loki:2.6.1|nginx:1.23.3)" |cat
        register: loki_all_image_status
      - block:
        - name: pull loki
          shell: docker pull swr.cn-east-2.myhuaweicloud.com/common-server/loki:2.6.1
        - name: pull nginx
          shell: docker pull swr.cn-east-2.myhuaweicloud.com/common-server/nginx:1.23.3
        - name: pull promtail
          shell: docker pull swr.cn-east-2.myhuaweicloud.com/common-server/promtail:2.6.1
        # - name: save loki all
        #   shell: docker save swr.cn-east-2.myhuaweicloud.com/common-server/loki:2.6.1 swr.cn-east-2.myhuaweicloud.com/common-server/nginx:1.23.3 | gzip > /tmp/loki_all.tgz
        - name: save loki all
          shell: docker save swr.cn-east-2.myhuaweicloud.com/common-server/promtail:2.6.1 | gzip > /tmp/promtail.tgz
        when: loki_all_image_status['stdout']|int < 2
      - block:
        - name: 初始化目录
          file:
            path: /opt/loki/loki/data
            state: directory
            mode: 0777
        - name: 初始化目录
          file:
            path: "{{ item }}"
            state: directory
            mode: 0775
          with_items:
            - /opt/loki/config
            - /opt/loki/loki
        - name: 初始化文件
          file:
            path: "{{ item }}"
            state: touch
            mode: 0664
          with_items:
            - /opt/loki/loki/loki-config.yaml
            - /opt/loki/config/nginx-loki-gateway.conf
        - name: 初始化文件/opt/loki/loki/loki-config.yaml
          blockinfile:
            path: /opt/loki/loki/loki-config.yaml
            block: |
              ---
              # 关闭多租户
              auth_enabled: false
              server:
                http_listen_port: 3100
                # http服务器读取超时
                http_server_read_timeout: 600s
                # http服务器写入超时
                http_server_write_timeout: 600s
                grpc_server_max_recv_msg_size: 104857600
                grpc_server_max_send_msg_size: 104857600

              analytics:
                reporting_enabled: false

              common:
                path_prefix: /loki
                replication_factor: 1
                ring:
                  kvstore:
                    store: memberlist

              ingester:
                lifecycler:
                  #address: 127.0.0.1   #ingester地址, 默认为本机127.0.0.1,如果有多台server也可以写多个
                  ring:
                    kvstore:
                      store: memberlist  #使用内存做为ingester存储
                    replication_factor: 1
                  final_sleep: 0s
                # 块的大小(以字节bytes为单位),262144
                #chunk_block_size: 262144
                # 用于块的压缩算法(gzip,lz4,snappy)
                #chunk_encoding: snappy
                # 在没有更新的情况下，块在内存中保留最长时间
                chunk_idle_period: 1m
                # 块刷新后，在内存中保留时间
                #chunk_retain_period: 30s
                wal:
                  # 允许写入wal
                  enabled: true
                  # 存储和恢复wal数据的目录, 默认/loki/wal
                  dir: /data/wal
                  # 是否在关机时将块刷新到长期存储
                  #flush_on_shutdown: true
                  # wal可以使用的最大内存大小
                  replay_memory_ceiling: 1GB
                  checkpoint_duration: 1m

              memberlist:
                # 要加入集群的成员
                join_members:
                  - logging-loki-write
                  - logging-loki-read
                dead_node_reclaim_time: 30s
                gossip_to_dead_nodes_time: 15s
                left_ingesters_timeout: 30s
                bind_addr: ['0.0.0.0']
                bind_port: 7946
                gossip_interval: 2s
                max_join_backoff: 1m
                max_join_retries: 10
                min_join_backoff: 1s
                # 如果此节点无法加入成员列表群集，请中止
                abort_if_cluster_join_fails: false

              schema_config:
                configs:
                  - from: 2022-09-01
                    store: boltdb-shipper
                    object_store: filesystem
                    schema: v11
                    index:
                      prefix: index_
                      period: 24h

              # 配置多个可能使用索引和块的存储, 供schema_config中选择
              storage_config:
                  boltdb_shipper:
                    active_index_directory: /data/index
                    cache_location: /data/index_cache
                    shared_store: filesystem
                    cache_ttl: 24h
                  filesystem:
                    directory: /data/chunks

              limits_config:
                # 查询返回的唯一系列最大值
                max_query_series: 100000
                retention_period: 24h         # 过期时间
                per_stream_rate_limit: 3MB # 每个流每秒的最大字节速率
                reject_old_samples: true      # 旧样品是否会被拒绝
                reject_old_samples_max_age: 24h      # 拒绝旧样本的最大时限
                enforce_metric_name: false
                #ingestion_rate_mb: 50 #每个用户每秒的采样率限制
                ingestion_rate_mb: 4 #每个用户每秒的采样率限制
                # 限制每行日志最大值
                # max_line_size: 30mb
                # max_line_size_truncate: true

              compactor:
                working_directory: /data/compactor
                shared_store: filesystem
                compaction_interval: 10m
                retention_enabled: true
                retention_delete_delay: 2h
                retention_delete_worker_count: 150

              chunk_store_config:
                  # 限制可查询的回溯数据的时间
                  max_look_back_period: 24h

              query_range:
                  align_queries_with_step: true
                  # 单个请求的最大重试次数
                  max_retries: 5
                  cache_results: true
                  results_cache:
                    cache:
                      # We're going to use the in-process "FIFO" cache
                      enable_fifocache: true
                      fifocache:
                        max_size_bytes: 100MB
                        ttl: 24h
                        # size: 1024
                        # validity: 24h

              query_scheduler:
                # 最大未完成请求数
                max_outstanding_requests_per_tenant: 2048

              ruler:
                storage:
                  type: local
                  local:
                    directory: /data/rules
        - name: 初始化文件/opt/loki/config/nginx-loki-gateway.conf
          blockinfile:
            path: /opt/loki/config/nginx-loki-gateway.conf
            block: |
              error_log  /dev/stderr;
              pid        /tmp/nginx.pid;
              worker_rlimit_nofile 8192;

              events {
                  worker_connections  4096;  ## Default: 1024
              }

              http {
                resolver 127.0.0.11;

                default_type application/octet-stream;
                log_format                 main ' $http_appversion | $remote_addr | $remote_user | $time_local | $request | '
                                                                    '$status | $body_bytes_sent | $http_referer | '
                                                                    '$http_user_agent | $http_x_forwarded_for | $request_time | $upstream_response_time | $upstream_addr | $upstream_status | $http_host ';
                access_log   /dev/stderr  main;
                sendfile     on;
                tcp_nopush   on;

                upstream write {
                  server logging-loki-write:3100;
                }

                upstream read {
                  server logging-loki-read:3100;
                }

                upstream  cluster {
                  server   logging-loki-read:3100;
                  server   logging-loki-write:3100;
                }


                server {
                  listen 3100;
                  location = / {
                      return 200 'OK';
                      default_type 'text/html';
                      charset utf-8;
                      auth_basic off;
                  }
                  location = /loki/api/v1/push {
                      proxy_pass       http://write$request_uri;
                  }
                  
                  location = /ring {
                      proxy_pass       http://read$request_uri;
                  }

                  location = /ready {
                      proxy_pass       http://cluster$request_uri;
                  }

                  location = /memberlist  {
                      proxy_pass http://read$request_uri;
                  }

                  location = /loki/api/v1/tail {
                      proxy_pass       http://read$request_uri;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }

                  location ~ /loki/api/.* {
                      proxy_pass       http://read$request_uri;
                  }

                  location ~ /prometheus/api/.* {
                      proxy_pass       http://read$request_uri;
                  }

                  location ~ /api/prom/.* {
                      proxy_pass       http://read$request_uri;
                  }
                }
              }
        when: loki_path.stat.isdir is not defined
      - name: 检查子网是否冲突
        fail:
          msg: "ERROR: docker自定义网络可能冲突,请检查172.30.30.0/24网段是否冲突后手动修改--subnet部分,创建network.\ndocker network create logging --driver bridge --subnet=172.30.30.0/24"
        when:
          - loki_network_register['stdout']|int == 0
          - loki_network_subnet_register['stdout']|int == 1
      - name: 创建network
        shell: docker network create logging --driver bridge --subnet=172.30.30.0/24
        when:
          - loki_network_register['stdout']|int == 0
          - loki_network_subnet_register['stdout']|int == 0
      - name: 启动write容器
        shell: |
          docker run -itd \
          --name logging-loki-write \
          --network logging \
          --network-alias logging-loki-write \
          --cpus 1 -m 2G \
          --restart=unless-stopped \
          --log-opt max-size=512m --log-opt max-file=3 \
          -v /etc/hosts:/etc/hosts \
          -v /etc/localtime:/etc/localtime \
          -v /opt/loki/loki/loki-config.yaml:/etc/loki/loki-config.yaml \
          -v /opt/loki/loki/data:/data \
          -e TZ=Asia/Shanghai \
          swr.cn-east-2.myhuaweicloud.com/common-server/loki:2.6.1 -config.file=/etc/loki/loki-config.yaml -target=write
      - name: 启动read容器
        shell: |
          docker run -itd \
          -u root \
          --name logging-loki-read \
          --network logging \
          --network-alias logging-loki-read \
          --cpus 2 -m 2G \
          --restart=unless-stopped \
          --log-opt max-size=512m --log-opt max-file=3 \
          -v /etc/hosts:/etc/hosts \
          -v /etc/localtime:/etc/localtime \
          -v /opt/loki/loki/loki-config.yaml:/etc/loki/loki-config.yaml \
          -v /opt/loki/loki/data:/data \
          -e TZ=Asia/Shanghai \
          swr.cn-east-2.myhuaweicloud.com/common-server/loki:2.6.1 -config.file=/etc/loki/loki-config.yaml -target=read
      - name: 启动gateway容器
        shell: |
          docker run -itd \
          --name logging-loki-gateway \
          --network logging \
          --network-alias logging-loki-gateway \
          -p 3100:3100 \
          --cpus 1 -m 2G \
          --restart=unless-stopped \
          --log-opt max-size=512m --log-opt max-file=3 \
          -v /etc/hosts:/etc/hosts \
          -v /etc/localtime:/etc/localtime \
          -v /opt/loki/config/nginx-loki-gateway.conf:/etc/nginx/nginx.conf \
          -e TZ=Asia/Shanghai \
          swr.cn-east-2.myhuaweicloud.com/common-server/nginx:1.23.3
      # - name: 删除镜像文件
      #   file:
      #     path: /tmp/loki_all.tgz
      #     state: absent
      when: 
        - loki_docker_register['stdout']|int == 0
        - loki_port_register['stdout']|int == 1


# Date: 2022-11-17 16:35
# Author: lglaboy
# GitHub: https://github.com/lglaboy
# Description: 安装promtail,往loki上面传
# Version: v1.0
- name: install promtail
  hosts: promtail_docker_hosts
  remote_user: swift
  gather_facts: False
  tasks:
    - name: Check whether local-loki exists in the /etc/hosts file
      shell: grep local-loki /etc/hosts -c|cat
      register: loki_hosts_register
    - name: Check to see if promtail is installed
      shell: docker ps |grep "logging-promtail" -c|cat
      register: promtail_docker_register
    - name: 检查network是否存在
      shell: docker network ls|grep logging -c|cat
      register: loki_network_register
    - name: 检查目录是否存在
      stat:
        path: /opt/promtail
      register: promtail_path
    - name: 检查本地目录是否存在
      connection: local
      stat:
        path: "/tmp/{{ inventory_hostname|lower|regex_replace('-(.*)') }}_loki_host"
      register: loki_host_file_status
    - block:
      - name: 检查promtail image是否存在
        shell: docker images |awk '{print $1":"$2}'|grep -c swr.cn-east-2.myhuaweicloud.com/common-server/promtail:2.6.1|cat
        register: promtail_image_status
      - block:
        - name: dump_host rsync to remote_hosts
          # 传输逻辑将跳板机上的镜像文件传至所有需要部署的机器
          # raw: scp /tmp/promtail.tgz "{{ inventory_hostname }}":/tmp && echo "scp ok!"
          synchronize:
            src: /tmp/promtail.tgz
            dest: /tmp/promtail.tgz
          delegate_to: "{{ item }}"
          loop: "{{ query('inventory_hostnames', pxe_hosts | default('loki_docker_hosts')) }}"
          retries: 2
          delay: 3
          register: result
          until: result.rc == 0
          when: ( groups['promtail_docker_hosts'] != groups['loki_docker_hosts'])
        # - name: copy promtail image to remote_host
        #   local_action: shell scp /home/swift/packages/promtail.tgz {{ inventory_hostname }}:/tmp
        - name: import docker image
          shell: docker load < /tmp/promtail.tgz
        when: promtail_image_status['stdout']|int == 0
      - name: 获取loki IP
        connection: local
        shell: cat "/tmp/{{ inventory_hostname|lower|regex_replace('-(.*)') }}_loki_host"
        register: loki_ip
      - name: 在/etc/hosts中添加local-loki的解析
        become: yes
        become_method: sudo
        shell: echo "\n# loki\n{{ loki_ip['stdout'] }}    local-loki" | tee -a /etc/hosts
        when: loki_hosts_register['stdout']|int == 0
      - name: 更新/etc/hosts中的local-loki解析
        become: yes
        become_method: sudo
        shell: sed -i 's#\(.*\)\(local-loki\)#{{ loki_ip['stdout'] }}    \2#g' /etc/hosts
        when: loki_hosts_register['stdout']|int == 1
      - block:
        - name: 初始化目录
          file:
            path: /opt/promtail
            state: directory
            mode: 0775
          # when: promtail_path.stat.isdir is not defined
        - name: 初始化文件
          file:
            path: /opt/promtail/promtail-config.yaml
            state: touch
            mode: 0664
        - name: 初始化文件/opt/promtail/promtail-config.yaml
          blockinfile:
            path: /opt/promtail/promtail-config.yaml
            block: |
              server:
                http_listen_port: 9080
                grpc_listen_port: 0

              positions:
                filename: /mnt/config/positions.yaml

              clients:
                - url: http://local-loki:3100/loki/api/v1/push
                  external_labels:
                    hostname: ${HOSTNAME}

              limits_config:
                readline_rate_enabled: true
                readline_rate: 4000
                readline_burst: 5000
                readline_rate_drop: false

              target_config:
                sync_period: "10s"

              scrape_configs:
                - job_name: service_logs
                  static_configs:
                  - targets:
                      - localhost
                    labels:
                      job: service_logs
                      agent: promtail
                      __path__: /opt/*/logs/*.log
                  pipeline_stages:
                    - match:
                        selector: '{job="service_logs"}'
                        stages:
                        - regex:
                            source: filename
                            expression: '/opt/(?P<service>\\S+?)/'
                        - labels:
                            service:
                - job_name: nginx_access_log
                  pipeline_stages:
                    - json:
                        expressions:
                          http_host: http_host
                    - labels:
                        http_host:
                    - match:
                        selector: '{job="nginx_access_log"}'
                        stages:
                        - regex:
                            source: filename
                            expression: '(?P<path>.*)/(?P<file_name>\\S+?)$'
                        - labels:
                            file_name:
                  static_configs:
                  - targets:
                      - localhost
                    labels:
                      job: nginx_access_log
                      host: ${HOSTNAME}
                      agent: promtail
                      __path__: /var/log/nginx/*access.log
        - name: 初始化文件/opt/promtail/positions.yaml
          # shell: echo "positions:" > /opt/promtail/positions.yaml && ls -al /opt/*/logs/*.log|awk '{print  "  " $NF ":\ " "\""$5"\""}' >> /opt/promtail/positions.yaml && ls -al /var/log/nginx/*access.log|awk '{print  "  " $NF ":\ " "\""$5"\""}' >> /opt/promtail/positions.yaml
          shell: echo "positions:" > /opt/promtail/positions.yaml && ls -al /opt/*/logs/*.log|awk '{print  "  " $NF ":" " " "\""$5"\""}' >> /opt/promtail/positions.yaml && ls -al /var/log/nginx/*access.log|awk '{print  "  " $NF ":" " " "\""$5"\""}' >> /opt/promtail/positions.yaml
        when: promtail_path.stat.isdir is not defined
      - name: 将logging-loki-gateway加入到bridge
        shell: docker network connect bridge logging-loki-gateway
        when:
          loki_network_register['stdout']|int == 1
      - name: 启动promtail容器
        shell: |
          docker run --name logging-promtail \
          -h $(hostname) \
          -itd \
          --cpus 1 -m 2G \
          --restart=unless-stopped \
          --log-opt max-size=512m \
          --log-opt max-file=3 \
          -v /etc/hosts:/etc/hosts \
          -v /etc/localtime:/etc/localtime \
          -v /opt:/opt \
          -v /var/log/nginx:/var/log/nginx \
          -v /opt/promtail:/mnt/config \
          swr.cn-east-2.myhuaweicloud.com/common-server/promtail:2.6.1 -config.file=/mnt/config/promtail-config.yaml -config.expand-env=true
      - name: 删除镜像文件
        file:
          path: /tmp/promtail.tgz
          state: absent
      when: 
        - promtail_docker_register['stdout']|int == 0
        - loki_host_file_status.stat.isreg is defined